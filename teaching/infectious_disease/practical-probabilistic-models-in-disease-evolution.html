<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Practical: probabilistic models in disease evolution | Epidemiological Modelling at Cermel: Practical Notes</title>
  <meta name="description" content="Course notes epidemiology" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Practical: probabilistic models in disease evolution | Epidemiological Modelling at Cermel: Practical Notes" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Course notes epidemiology" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Practical: probabilistic models in disease evolution | Epidemiological Modelling at Cermel: Practical Notes" />
  
  <meta name="twitter:description" content="Course notes epidemiology" />
  

<meta name="author" content="Bram Kuijper, Mario Recker" />


<meta name="date" content="2024-03-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="practical-uncertainties.html"/>
<link rel="next" href="practical-fitting-dynamic-models-to-data.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.32/datatables.js"></script>
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="libs/dt-ext-buttons-1.13.6/css/buttons.dataTables.min.css" rel="stylesheet" />
<script src="libs/dt-ext-buttons-1.13.6/js/dataTables.buttons.min.js"></script>
<script src="libs/dt-ext-buttons-1.13.6/js/buttons.html5.min.js"></script>
<script src="libs/dt-ext-buttons-1.13.6/js/buttons.colVis.min.js"></script>
<script src="libs/dt-ext-buttons-1.13.6/js/buttons.print.min.js"></script>
<link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Course notes epidemiological modelling</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Practical notes for days 4 and 5</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#copying-code"><i class="fa fa-check"></i><b>1.1</b> Copying code</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#what-to-work-on"><i class="fa fa-check"></i><b>1.2</b> What to work on?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html"><i class="fa fa-check"></i><b>2</b> Practical: uncertainties</a>
<ul>
<li class="chapter" data-level="2.1" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#estimating-r_0-in-a-risk-heterogenous-population"><i class="fa fa-check"></i><b>2.1</b> Estimating <span class="math inline">\(R_{0}\)</span> in a risk-heterogenous population</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#sis-model-code"><i class="fa fa-check"></i><b>2.1.1</b> SIS model code</a></li>
<li class="chapter" data-level="2.1.2" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#task-estimate-r0-without-taking-into-account-risk"><i class="fa fa-check"></i><b>2.1.2</b> Task: estimate R0 without taking into account risk</a></li>
<li class="chapter" data-level="2.1.3" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#task-estimate-r0-while-taking-into-account-risk"><i class="fa fa-check"></i><b>2.1.3</b> Task: estimate R0 while taking into account risk</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#maximum-likelihood-and-age-dependent-seropositivity"><i class="fa fa-check"></i><b>2.2</b> Maximum likelihood and age-dependent seropositivity</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#the-datasets"><i class="fa fa-check"></i><b>2.2.1</b> The datasets</a></li>
<li class="chapter" data-level="2.2.2" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#dataset-1-quite-some-susceptibles-in-early-life"><i class="fa fa-check"></i><b>2.2.2</b> Dataset 1: quite some susceptibles in early life</a></li>
<li class="chapter" data-level="2.2.3" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#dataset-2-only-a-few-susceptibles-in-early-life"><i class="fa fa-check"></i><b>2.2.3</b> Dataset 2: only a few susceptibles in early life</a></li>
<li class="chapter" data-level="2.2.4" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#dataset-3-loss-of-immunity-in-later-life"><i class="fa fa-check"></i><b>2.2.4</b> Dataset 3: loss of immunity in later life</a></li>
<li class="chapter" data-level="2.2.5" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#probabilities-and-the-likelihood-function"><i class="fa fa-check"></i><b>2.2.5</b> Probabilities and the likelihood function</a></li>
<li class="chapter" data-level="2.2.6" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#task-calculating-the-log-likelihood-for-r_0-3"><i class="fa fa-check"></i><b>2.2.6</b> Task: calculating the log-likelihood for <span class="math inline">\(R_{0} = 3\)</span></a></li>
<li class="chapter" data-level="2.2.7" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#task-calculate-the-log-likelihood-for-a-range-of-r_0-values"><i class="fa fa-check"></i><b>2.2.7</b> Task: calculate the log-likelihood for a range of <span class="math inline">\(R_{0}\)</span> values</a></li>
<li class="chapter" data-level="2.2.8" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#task-calculate-log-likelihood-for-the-other-datasets"><i class="fa fa-check"></i><b>2.2.8</b> Task: calculate log likelihood for the other datasets</a></li>
<li class="chapter" data-level="2.2.9" data-path="practical-uncertainties.html"><a href="practical-uncertainties.html#task-thinking-further-about-the-loss-of-immunity-dataset"><i class="fa fa-check"></i><b>2.2.9</b> Task: thinking further about the loss of immunity dataset</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html"><i class="fa fa-check"></i><b>3</b> Practical: probabilistic models in disease evolution</a>
<ul>
<li class="chapter" data-level="3.1" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#gamma-chain-models"><i class="fa fa-check"></i><b>3.1</b> Gamma chain models</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#gamma-chain-model-code"><i class="fa fa-check"></i><b>3.1.1</b> Gamma chain model code</a></li>
<li class="chapter" data-level="3.1.2" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-run-the-gamma-chain-model"><i class="fa fa-check"></i><b>3.1.2</b> Task: run the gamma chain model</a></li>
<li class="chapter" data-level="3.1.3" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-lower-the-r_0-value-in-the-gamma-chain-model"><i class="fa fa-check"></i><b>3.1.3</b> Task: lower the <span class="math inline">\(R_{0}\)</span> value in the gamma chain model</a></li>
<li class="chapter" data-level="3.1.4" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-increase-n"><i class="fa fa-check"></i><b>3.1.4</b> Task: increase <span class="math inline">\(n\)</span></a></li>
<li class="chapter" data-level="3.1.5" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#extra-trouble-arises-when-one-increases-n-even-further"><i class="fa fa-check"></i><b>3.1.5</b> Extra: trouble arises when one increases <span class="math inline">\(n\)</span> even further</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#working-with-gillespie-models"><i class="fa fa-check"></i><b>3.2</b> Working with Gillespie models</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#gillespie-model-code"><i class="fa fa-check"></i><b>3.2.1</b> Gillespie model code</a></li>
<li class="chapter" data-level="3.2.2" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-running-the-model"><i class="fa fa-check"></i><b>3.2.2</b> Task: running the model</a></li>
<li class="chapter" data-level="3.2.3" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-running-the-above-for-small-population-sizes"><i class="fa fa-check"></i><b>3.2.3</b> Task: running the above for small population sizes</a></li>
<li class="chapter" data-level="3.2.4" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-running-and-plotting-replicate-sims"><i class="fa fa-check"></i><b>3.2.4</b> Task: running and plotting replicate sims</a></li>
<li class="chapter" data-level="3.2.5" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#task-what-happens-when-r_0-1"><i class="fa fa-check"></i><b>3.2.5</b> Task: what happens when <span class="math inline">\(R_{0} &lt; 1\)</span>?</a></li>
<li class="chapter" data-level="3.2.6" data-path="practical-probabilistic-models-in-disease-evolution.html"><a href="practical-probabilistic-models-in-disease-evolution.html#advanced-task-systematically-vary-population-size-and-look-at-extinction"><i class="fa fa-check"></i><b>3.2.6</b> Advanced task: systematically vary population size and look at extinction</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html"><i class="fa fa-check"></i><b>4</b> Practical: fitting dynamic models to data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html#hong-kong-flu-data-set"><i class="fa fa-check"></i><b>4.1</b> Hong Kong flu data set</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html#curve-fitting-code-using-optim"><i class="fa fa-check"></i><b>4.1.1</b> Curve fitting code using <code>optim()</code></a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html#task-calculate-the-sum-of-squares-for-your-own-wild-guess-of-beta-and-sigma"><i class="fa fa-check"></i><b>4.2</b> Task: calculate the sum of squares for your own wild guess of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span></a></li>
<li class="chapter" data-level="4.3" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html#task-run-optim-to-find-the-best-fit-of-beta-and-sigma"><i class="fa fa-check"></i><b>4.3</b> Task: run <code>optim()</code> to find the best fit of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span></a></li>
<li class="chapter" data-level="4.4" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html#plotting-the-data-and-the-best-fit-model"><i class="fa fa-check"></i><b>4.4</b> Plotting the data and the best-fit model</a></li>
<li class="chapter" data-level="4.5" data-path="practical-fitting-dynamic-models-to-data.html"><a href="practical-fitting-dynamic-models-to-data.html#task-missing-data"><i class="fa fa-check"></i><b>4.5</b> Task: missing data</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Epidemiological Modelling at Cermel: Practical Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="practical-probabilistic-models-in-disease-evolution" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Practical: probabilistic models in disease evolution<a href="practical-probabilistic-models-in-disease-evolution.html#practical-probabilistic-models-in-disease-evolution" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Here we will focus on two applications:
1. A so-called ‘gamma-chain’ model to explore the impact of more realistic recovery distributions.
2. The famous Gillespie Model of Stochastic disease modelling, to track probabilistic changes in densities.</p>
<div id="gamma-chain-models" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Gamma chain models<a href="practical-probabilistic-models-in-disease-evolution.html#gamma-chain-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>During the lectures, we discussed that more realistic distributions of the recovery time <span class="math inline">\(\sigma\)</span> may change the
spread of the disease onset as well as peak
numbers of infected.</p>
<p>Here, we will demonstrate this ourselves by running our own gamma chain model. A key parameter here is <span class="math inline">\(n\)</span>, the number of stages through which an individual has to pass before clearing the disease. This could, for example, reflect the time it takes before the immune system kicks in or before treatment finally starts to work and clear the disease.</p>
<div id="gamma-chain-model-code" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Gamma chain model code<a href="practical-probabilistic-models-in-disease-evolution.html#gamma-chain-model-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="practical-probabilistic-models-in-disease-evolution.html#cb6-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;deSolve&quot;</span>)</span>
<span id="cb6-2"><a href="practical-probabilistic-models-in-disease-evolution.html#cb6-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span></code></pre></div>
<pre><code>## ── Attaching core tidyverse packages ──────────────────────────────────── tidyverse 2.0.0 ──
## ✔ dplyr     1.1.4     ✔ readr     2.1.5
## ✔ forcats   1.0.0     ✔ stringr   1.5.1
## ✔ ggplot2   3.4.4     ✔ tibble    3.2.1
## ✔ lubridate 1.9.3     ✔ tidyr     1.3.1
## ✔ purrr     1.0.2     
## ── Conflicts ────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-1" tabindex="-1"></a><span class="co"># incorporate a gamma distribution </span></span>
<span id="cb8-2"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-2" tabindex="-1"></a><span class="co"># of infection time </span></span>
<span id="cb8-3"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-3" tabindex="-1"></a><span class="co"># into an SIR model</span></span>
<span id="cb8-4"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-4" tabindex="-1"></a>sir_chain_mod <span class="ot">&lt;-</span> <span class="cf">function</span>(t, init_densities, parameters) </span>
<span id="cb8-5"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-5" tabindex="-1"></a>{ </span>
<span id="cb8-6"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-6" tabindex="-1"></a>    <span class="co"># vector with all the densities </span></span>
<span id="cb8-7"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-7" tabindex="-1"></a>    <span class="co"># received via the command line</span></span>
<span id="cb8-8"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-8" tabindex="-1"></a>    x <span class="ot">&lt;-</span> init_densities</span>
<span id="cb8-9"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-9" tabindex="-1"></a>   </span>
<span id="cb8-10"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-10" tabindex="-1"></a>    <span class="co"># derive the total population size from </span></span>
<span id="cb8-11"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-11" tabindex="-1"></a>    <span class="co"># the sum of the densities</span></span>
<span id="cb8-12"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-12" tabindex="-1"></a>    N <span class="ot">&lt;-</span> <span class="fu">sum</span>(init_densities)</span>
<span id="cb8-13"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-13" tabindex="-1"></a>    </span>
<span id="cb8-14"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-14" tabindex="-1"></a>    <span class="co"># number of time steps an individual needs</span></span>
<span id="cb8-15"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-15" tabindex="-1"></a>    <span class="co"># to undergo before the infection is cleared</span></span>
<span id="cb8-16"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-16" tabindex="-1"></a>    n <span class="ot">&lt;-</span> parameters[<span class="st">&quot;n&quot;</span>]</span>
<span id="cb8-17"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-17" tabindex="-1"></a>    </span>
<span id="cb8-18"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-18" tabindex="-1"></a>    <span class="co"># we need at least one infected stage</span></span>
<span id="cb8-19"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-19" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb8-20"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-20" tabindex="-1"></a>    </span>
<span id="cb8-21"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-21" tabindex="-1"></a>    <span class="co"># some bounds checking</span></span>
<span id="cb8-22"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-22" tabindex="-1"></a>    <span class="co"># we expect one density for S and R each</span></span>
<span id="cb8-23"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-23" tabindex="-1"></a>    <span class="co"># and n densities for I, making n+2</span></span>
<span id="cb8-24"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-24" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(x) <span class="sc">==</span> n <span class="sc">+</span> <span class="dv">2</span>)</span>
<span id="cb8-25"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-25" tabindex="-1"></a>    </span>
<span id="cb8-26"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-26" tabindex="-1"></a>    <span class="co"># initial density of S, this is only a single value</span></span>
<span id="cb8-27"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-27" tabindex="-1"></a>    S <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb8-28"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-28" tabindex="-1"></a>    </span>
<span id="cb8-29"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-29" tabindex="-1"></a>    <span class="co"># initial density of I, because we have now</span></span>
<span id="cb8-30"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-30" tabindex="-1"></a>    <span class="co"># different compartments this is a whole</span></span>
<span id="cb8-31"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-31" tabindex="-1"></a>    <span class="co"># range of values</span></span>
<span id="cb8-32"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-32" tabindex="-1"></a>    I <span class="ot">&lt;-</span> x[<span class="dv">2</span><span class="sc">:</span>(n <span class="sc">+</span> <span class="dv">1</span>)]</span>
<span id="cb8-33"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-33" tabindex="-1"></a>    </span>
<span id="cb8-34"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-34" tabindex="-1"></a>    <span class="co"># then finally get the fraction of resistant</span></span>
<span id="cb8-35"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-35" tabindex="-1"></a>    <span class="co"># individuals from the population density vector</span></span>
<span id="cb8-36"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-36" tabindex="-1"></a>    R <span class="ot">&lt;-</span> x[n <span class="sc">+</span> <span class="dv">2</span>] </span>
<span id="cb8-37"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-37" tabindex="-1"></a>    </span>
<span id="cb8-38"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-38" tabindex="-1"></a>    <span class="fu">with</span>(<span class="fu">as.list</span>(parameters), {</span>
<span id="cb8-39"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-39" tabindex="-1"></a>        total_I <span class="ot">&lt;-</span> <span class="fu">sum</span>(I)</span>
<span id="cb8-40"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-40" tabindex="-1"></a>        </span>
<span id="cb8-41"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-41" tabindex="-1"></a>        <span class="co"># dS/dt is just the same as</span></span>
<span id="cb8-42"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-42" tabindex="-1"></a>        <span class="co"># it ever was</span></span>
<span id="cb8-43"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-43" tabindex="-1"></a>        dS <span class="ot">&lt;-</span> mu <span class="sc">*</span> N <span class="sc">-</span> beta <span class="sc">*</span> S <span class="sc">*</span> total_I <span class="sc">/</span> N  <span class="sc">-</span> mu <span class="sc">*</span> S</span>
<span id="cb8-44"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-44" tabindex="-1"></a>        </span>
<span id="cb8-45"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-45" tabindex="-1"></a>        <span class="co"># allocate empty space filled</span></span>
<span id="cb8-46"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-46" tabindex="-1"></a>        <span class="co"># with zeros for the n  dI/dts</span></span>
<span id="cb8-47"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-47" tabindex="-1"></a>        dI <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="at">length =</span> n)</span>
<span id="cb8-48"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-48" tabindex="-1"></a>        </span>
<span id="cb8-49"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-49" tabindex="-1"></a>        <span class="co"># dI1/dt is a bit special as it receives</span></span>
<span id="cb8-50"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-50" tabindex="-1"></a>        <span class="co"># susceptibles whereas dI2/dt etc do not</span></span>
<span id="cb8-51"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-51" tabindex="-1"></a>        <span class="co"># hence write dI1/dt outside</span></span>
<span id="cb8-52"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-52" tabindex="-1"></a>        <span class="co"># the for loop</span></span>
<span id="cb8-53"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-53" tabindex="-1"></a>        dI[<span class="dv">1</span>] <span class="ot">&lt;-</span> beta <span class="sc">*</span> S <span class="sc">*</span> total_I <span class="sc">/</span> N <span class="sc">-</span> </span>
<span id="cb8-54"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-54" tabindex="-1"></a>            (mu <span class="sc">+</span> n <span class="sc">*</span> sigma) <span class="sc">*</span> I[<span class="dv">1</span>]</span>
<span id="cb8-55"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-55" tabindex="-1"></a>        </span>
<span id="cb8-56"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-56" tabindex="-1"></a>        <span class="co"># evaluate all the the dI_i equations</span></span>
<span id="cb8-57"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-57" tabindex="-1"></a>        <span class="cf">if</span> (n <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb8-58"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-58" tabindex="-1"></a>        {</span>
<span id="cb8-59"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-59" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb8-60"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-60" tabindex="-1"></a>            {</span>
<span id="cb8-61"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-61" tabindex="-1"></a>                dI[i] <span class="ot">&lt;-</span> n <span class="sc">*</span> sigma <span class="sc">*</span> I[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">-</span> </span>
<span id="cb8-62"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-62" tabindex="-1"></a>                    (n <span class="sc">*</span> sigma <span class="sc">+</span> mu) <span class="sc">*</span> I[i]</span>
<span id="cb8-63"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-63" tabindex="-1"></a>            }</span>
<span id="cb8-64"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-64" tabindex="-1"></a>        }</span>
<span id="cb8-65"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-65" tabindex="-1"></a>        </span>
<span id="cb8-66"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-66" tabindex="-1"></a>        <span class="co"># and finally dR/dt</span></span>
<span id="cb8-67"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-67" tabindex="-1"></a>        dR <span class="ot">&lt;-</span> n <span class="sc">*</span> sigma <span class="sc">*</span> I[n] <span class="sc">-</span> mu <span class="sc">*</span> R</span>
<span id="cb8-68"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-68" tabindex="-1"></a>     </span>
<span id="cb8-69"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-69" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">c</span>(dS, dI, dR)   </span>
<span id="cb8-70"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-70" tabindex="-1"></a>        </span>
<span id="cb8-71"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-71" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">list</span>(result))</span>
<span id="cb8-72"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-72" tabindex="-1"></a>    }) </span>
<span id="cb8-73"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-73" tabindex="-1"></a>} <span class="co"># end sir_chain_mod()</span></span>
<span id="cb8-74"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-74" tabindex="-1"></a></span>
<span id="cb8-75"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-75" tabindex="-1"></a><span class="co"># first define all parameters but n,</span></span>
<span id="cb8-76"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-76" tabindex="-1"></a><span class="co"># as we will vary n below</span></span>
<span id="cb8-77"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-77" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">sigma =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">20</span>, <span class="at">beta =</span> <span class="dv">1</span>, <span class="at">mu =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">75</span>)</span>
<span id="cb8-78"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-78" tabindex="-1"></a></span>
<span id="cb8-79"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-79" tabindex="-1"></a><span class="co"># now make a copy to use for the model</span></span>
<span id="cb8-80"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-80" tabindex="-1"></a><span class="co"># with one infectious class, in which we specify</span></span>
<span id="cb8-81"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-81" tabindex="-1"></a><span class="co"># n = 1</span></span>
<span id="cb8-82"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-82" tabindex="-1"></a>parameters.n1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">n =</span> <span class="dv">1</span>, parameters)</span>
<span id="cb8-83"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-83" tabindex="-1"></a></span>
<span id="cb8-84"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-84" tabindex="-1"></a><span class="co"># once we have the parameters,</span></span>
<span id="cb8-85"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-85" tabindex="-1"></a><span class="co"># produce a vector of initial densities</span></span>
<span id="cb8-86"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-86" tabindex="-1"></a><span class="co"># pay attention to how we initialize I</span></span>
<span id="cb8-87"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-87" tabindex="-1"></a><span class="co"># there are now n different infected types</span></span>
<span id="cb8-88"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-88" tabindex="-1"></a><span class="co"># with I1 = 1, all other I = 0 as initial density</span></span>
<span id="cb8-89"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-89" tabindex="-1"></a>initial_densities <span class="ot">=</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">9999</span>,</span>
<span id="cb8-90"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-90" tabindex="-1"></a>                      <span class="at">I =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">numeric</span>(<span class="at">length =</span> parameters.n1[<span class="st">&quot;n&quot;</span>]<span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb8-91"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-91" tabindex="-1"></a>                      <span class="at">R =</span> <span class="dv">0</span></span>
<span id="cb8-92"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-92" tabindex="-1"></a>                      )</span>
<span id="cb8-93"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-93" tabindex="-1"></a></span>
<span id="cb8-94"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-94" tabindex="-1"></a><span class="co"># set the sequence of time points to solve</span></span>
<span id="cb8-95"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-95" tabindex="-1"></a><span class="co"># the gamma chain ode over</span></span>
<span id="cb8-96"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-96" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">250</span>, <span class="at">by =</span><span class="fl">0.1</span>)</span>
<span id="cb8-97"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-97" tabindex="-1"></a></span>
<span id="cb8-98"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-98" tabindex="-1"></a><span class="co"># run the model for n = 1</span></span>
<span id="cb8-99"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-99" tabindex="-1"></a>result.n1 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(<span class="at">y =</span> initial_densities, </span>
<span id="cb8-100"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-100" tabindex="-1"></a>                            <span class="at">times =</span> times, </span>
<span id="cb8-101"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-101" tabindex="-1"></a>                            <span class="at">func =</span> sir_chain_mod, </span>
<span id="cb8-102"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-102" tabindex="-1"></a>                            <span class="at">parms =</span>parameters.n1)) </span>
<span id="cb8-103"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-103" tabindex="-1"></a></span>
<span id="cb8-104"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-104" tabindex="-1"></a><span class="co"># now run the model for a higher </span></span>
<span id="cb8-105"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-105" tabindex="-1"></a><span class="co"># number of classes that infecteds</span></span>
<span id="cb8-106"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-106" tabindex="-1"></a><span class="co"># have to pass through, ie., n &gt; 1</span></span>
<span id="cb8-107"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-107" tabindex="-1"></a>parameters.nhigher <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">n =</span> <span class="dv">3</span>, parameters)</span>
<span id="cb8-108"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-108" tabindex="-1"></a></span>
<span id="cb8-109"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-109" tabindex="-1"></a><span class="co"># again set initial densities</span></span>
<span id="cb8-110"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-110" tabindex="-1"></a>initial_densities <span class="ot">=</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">9999</span>,</span>
<span id="cb8-111"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-111" tabindex="-1"></a>                      <span class="at">I =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">numeric</span>(<span class="at">length =</span> parameters.nhigher[<span class="st">&quot;n&quot;</span>]<span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb8-112"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-112" tabindex="-1"></a>                      <span class="at">R =</span> <span class="dv">0</span></span>
<span id="cb8-113"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-113" tabindex="-1"></a>                      )</span>
<span id="cb8-114"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-114" tabindex="-1"></a></span>
<span id="cb8-115"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-115" tabindex="-1"></a><span class="co"># capture the results of the model</span></span>
<span id="cb8-116"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-116" tabindex="-1"></a>result.nhigher <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">ode</span>(<span class="at">y =</span> initial_densities, </span>
<span id="cb8-117"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-117" tabindex="-1"></a>                            <span class="at">times =</span> times, </span>
<span id="cb8-118"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-118" tabindex="-1"></a>                            <span class="at">func =</span> sir_chain_mod, </span>
<span id="cb8-119"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-119" tabindex="-1"></a>                            <span class="at">parms =</span>parameters.nhigher)) </span>
<span id="cb8-120"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-120" tabindex="-1"></a></span>
<span id="cb8-121"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-121" tabindex="-1"></a><span class="co"># now we need to get the total number of infecteds</span></span>
<span id="cb8-122"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-122" tabindex="-1"></a><span class="co"># across all the classes</span></span>
<span id="cb8-123"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-123" tabindex="-1"></a><span class="co"># we also label the rows of the dataset</span></span>
<span id="cb8-124"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-124" tabindex="-1"></a>result.n1 <span class="ot">&lt;-</span> result.n1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb8-125"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-125" tabindex="-1"></a>    <span class="at">totalI =</span> result.n1 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;I&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">rowSums</span>(),</span>
<span id="cb8-126"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-126" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">&quot;n = 1&quot;</span></span>
<span id="cb8-127"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-127" tabindex="-1"></a>)</span>
<span id="cb8-128"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-128" tabindex="-1"></a></span>
<span id="cb8-129"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-129" tabindex="-1"></a><span class="co"># now we need to get the total number of infecteds</span></span>
<span id="cb8-130"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-130" tabindex="-1"></a><span class="co"># across all the classes</span></span>
<span id="cb8-131"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-131" tabindex="-1"></a>result.nhigher <span class="ot">&lt;-</span> result.nhigher <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb8-132"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-132" tabindex="-1"></a>    <span class="at">totalI =</span> result.nhigher <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;I&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">rowSums</span>(),</span>
<span id="cb8-133"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-133" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">&quot;n &gt; 1&quot;</span></span>
<span id="cb8-134"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-134" tabindex="-1"></a>)</span>
<span id="cb8-135"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-135" tabindex="-1"></a></span>
<span id="cb8-136"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-136" tabindex="-1"></a><span class="co"># finally we need to combine both data.frames</span></span>
<span id="cb8-137"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-137" tabindex="-1"></a><span class="co"># so that we can plot the results</span></span>
<span id="cb8-138"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-138" tabindex="-1"></a>overall.data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb8-139"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-139" tabindex="-1"></a>    result.n1 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(time, totalI, type)),</span>
<span id="cb8-140"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-140" tabindex="-1"></a>    result.nhigher <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(time, totalI, type))</span>
<span id="cb8-141"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-141" tabindex="-1"></a>)</span>
<span id="cb8-142"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-142" tabindex="-1"></a></span>
<span id="cb8-143"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-143" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> overall.data,</span>
<span id="cb8-144"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-144" tabindex="-1"></a>       <span class="at">mapping=</span> <span class="fu">aes</span>(<span class="at">x =</span> time, </span>
<span id="cb8-145"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-145" tabindex="-1"></a>                    <span class="at">y =</span> totalI)) <span class="sc">+</span></span>
<span id="cb8-146"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-146" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">colour=</span>type)) <span class="sc">+</span></span>
<span id="cb8-147"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-147" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Total density of I&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-148"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-148" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-149"><a href="practical-probabilistic-models-in-disease-evolution.html#cb8-149" tabindex="-1"></a>    <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
<div id="task-run-the-gamma-chain-model" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Task: run the gamma chain model<a href="practical-probabilistic-models-in-disease-evolution.html#task-run-the-gamma-chain-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Copy the code above to a clean script window in Rstudio and run it. Can you look the parameters above and find the value of <span class="math inline">\(R_{0}\)</span> = <span class="math inline">\(\beta\)</span> / <span class="math inline">\(\sigma\)</span> ?</p>
<p>Do you see any differences between <span class="math inline">\(n = 1\)</span> (the classical SIR) and <span class="math inline">\(n &gt; 1\)</span> (the gamma chain model)?</p>
</div>
<div id="task-lower-the-r_0-value-in-the-gamma-chain-model" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Task: lower the <span class="math inline">\(R_{0}\)</span> value in the gamma chain model<a href="practical-probabilistic-models-in-disease-evolution.html#task-lower-the-r_0-value-in-the-gamma-chain-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now run the same model again, but for lower values of <span class="math inline">\(R_{0}\)</span> than previously considered. For example, by
setting <span class="math inline">\(\sigma = 1/4\)</span> while maintaining <span class="math inline">\(\beta = 1\)</span> (what is <span class="math inline">\(R_{0}\)</span> now?). You should now see that both lines fluctuate before settling on an equilibrium.</p>
<p>However, what is different about the fluctuations for <span class="math inline">\(n &gt; 1\)</span> versus <span class="math inline">\(n = 1\)</span>? Why do you think this is?</p>
</div>
<div id="task-increase-n" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Task: increase <span class="math inline">\(n\)</span><a href="practical-probabilistic-models-in-disease-evolution.html#task-increase-n" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now increase <span class="math inline">\(n\)</span> to, for example, <span class="math inline">\(n = 10\)</span>, so that
individuals need to pass through more stages before
clearing the disease.
Compare your results to the previous task. What has changed?</p>
</div>
<div id="extra-trouble-arises-when-one-increases-n-even-further" class="section level3 hasAnchor" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> Extra: trouble arises when one increases <span class="math inline">\(n\)</span> even further<a href="practical-probabilistic-models-in-disease-evolution.html#extra-trouble-arises-when-one-increases-n-even-further" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you would change <span class="math inline">\(n\)</span> to even larger values something ‘interesting’ happens, namely that <code>ode()</code>
now often fails to solve the model or gives spurious results.</p>
<p>This happens because the densities of infecteds are
now distributed over so many classes that the per-class
densities of <span class="math inline">\(I_{i}\)</span> simply become too low to solve for <code>ode()</code>. Slightly more
advanced methods are needed, for example by transforming
the densities to a log scale (e.g., see the code in Bjørnstad 2023, p. 27). Those of you really interested in this, try to change the model code above to</p>
</div>
</div>
<div id="working-with-gillespie-models" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Working with Gillespie models<a href="practical-probabilistic-models-in-disease-evolution.html#working-with-gillespie-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Gillespie models are a fantastic way to develop stochastic formulations of ordinary differential equations, including the SIR model.</p>
<p>Their area of application is enormous, from quan</p>
<div id="gillespie-model-code" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Gillespie model code<a href="practical-probabilistic-models-in-disease-evolution.html#gillespie-model-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here the code that will be covered during the practical. If you compare this to a deterministic model what do you see?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-1" tabindex="-1"></a><span class="co"># SIR model Gillespie</span></span>
<span id="cb9-2"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb9-3"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-4" tabindex="-1"></a><span class="co"># develops the various rates of the SIR models</span></span>
<span id="cb9-5"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-5" tabindex="-1"></a><span class="co"># and the resulting changes in density of S, I or R</span></span>
<span id="cb9-6"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-6" tabindex="-1"></a>stoch_eqns <span class="ot">&lt;-</span> <span class="cf">function</span>(input, params) {</span>
<span id="cb9-7"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-8" tabindex="-1"></a>    <span class="co"># rows of a data frame are in list()</span></span>
<span id="cb9-9"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-9" tabindex="-1"></a>    <span class="co"># format which may give trouble. Hence</span></span>
<span id="cb9-10"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-10" tabindex="-1"></a>    <span class="co"># I use unlist()</span></span>
<span id="cb9-11"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-11" tabindex="-1"></a>    input <span class="ot">&lt;-</span> <span class="fu">unlist</span>(input)</span>
<span id="cb9-12"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-12" tabindex="-1"></a>    </span>
<span id="cb9-13"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-13" tabindex="-1"></a>    <span class="co"># the current value of time</span></span>
<span id="cb9-14"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-14" tabindex="-1"></a>    ts <span class="ot">&lt;-</span> input[<span class="dv">1</span>]</span>
<span id="cb9-15"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-15" tabindex="-1"></a>    </span>
<span id="cb9-16"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-16" tabindex="-1"></a>    <span class="co"># the initial densities</span></span>
<span id="cb9-17"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-17" tabindex="-1"></a>    dens <span class="ot">&lt;-</span> input[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb9-18"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-18" tabindex="-1"></a>    </span>
<span id="cb9-19"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-19" tabindex="-1"></a>    </span>
<span id="cb9-20"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-20" tabindex="-1"></a>    <span class="co"># pre-allocate a</span></span>
<span id="cb9-21"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-21" tabindex="-1"></a>    <span class="co"># 6 x 3 matrix reflecting the change in densities of</span></span>
<span id="cb9-22"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-22" tabindex="-1"></a>    <span class="co"># S, I or R during one event</span></span>
<span id="cb9-23"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-23" tabindex="-1"></a>    density_change_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb9-24"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-24" tabindex="-1"></a>        <span class="at">data=</span><span class="dv">0</span> <span class="co"># fill it with zeros</span></span>
<span id="cb9-25"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-25" tabindex="-1"></a>        ,<span class="at">nrow=</span><span class="dv">6</span> <span class="co"># 6 events hence six rows</span></span>
<span id="cb9-26"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-26" tabindex="-1"></a>        ,<span class="at">ncol=</span><span class="fu">length</span>(dens))</span>
<span id="cb9-27"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-27" tabindex="-1"></a>    </span>
<span id="cb9-28"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-28" tabindex="-1"></a>    <span class="co"># allocate a matrix for all the density changes</span></span>
<span id="cb9-29"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-29" tabindex="-1"></a>    density_change_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="dv">0</span>, </span>
<span id="cb9-30"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-30" tabindex="-1"></a>                                    <span class="at">nrow =</span> <span class="dv">6</span>, </span>
<span id="cb9-31"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-31" tabindex="-1"></a>                                    <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> T)</span>
<span id="cb9-32"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-32" tabindex="-1"></a>    </span>
<span id="cb9-33"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-33" tabindex="-1"></a>    <span class="co"># total density at the start    </span></span>
<span id="cb9-34"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-34" tabindex="-1"></a>    Ntotal <span class="ot">&lt;-</span> <span class="fu">sum</span>(dens)</span>
<span id="cb9-35"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-35" tabindex="-1"></a>    </span>
<span id="cb9-36"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-36" tabindex="-1"></a>    <span class="co"># extinction</span></span>
<span id="cb9-37"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-37" tabindex="-1"></a>    <span class="cf">if</span> (Ntotal <span class="sc">&lt;=</span> <span class="dv">0</span>)</span>
<span id="cb9-38"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-38" tabindex="-1"></a>    {</span>
<span id="cb9-39"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-39" tabindex="-1"></a>        <span class="co"># return the current time steps and all</span></span>
<span id="cb9-40"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-40" tabindex="-1"></a>        <span class="co"># densities set to 0</span></span>
<span id="cb9-41"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-41" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">c</span>(ts,<span class="fu">numeric</span>(<span class="at">length=</span><span class="fu">length</span>(dens))))</span>
<span id="cb9-42"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-42" tabindex="-1"></a>    }</span>
<span id="cb9-43"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-43" tabindex="-1"></a>     </span>
<span id="cb9-44"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-44" tabindex="-1"></a>    <span class="co"># then fill the rates vector</span></span>
<span id="cb9-45"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-45" tabindex="-1"></a>    rates <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="at">length =</span> <span class="dv">6</span>)</span>
<span id="cb9-46"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-46" tabindex="-1"></a>    </span>
<span id="cb9-47"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-47" tabindex="-1"></a>    <span class="co"># normally we use with() to make </span></span>
<span id="cb9-48"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-48" tabindex="-1"></a>    <span class="co"># the parameters named vector into</span></span>
<span id="cb9-49"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-49" tabindex="-1"></a>    <span class="co"># variables, but with() is slooooow</span></span>
<span id="cb9-50"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-50" tabindex="-1"></a>    lambda <span class="ot">=</span> parameters[<span class="st">&quot;lambda&quot;</span>]</span>
<span id="cb9-51"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-51" tabindex="-1"></a>    beta <span class="ot">=</span> parameters[<span class="st">&quot;beta&quot;</span>]</span>
<span id="cb9-52"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-52" tabindex="-1"></a>    mu <span class="ot">=</span> parameters[<span class="st">&quot;mu&quot;</span>]</span>
<span id="cb9-53"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-53" tabindex="-1"></a>    sigma <span class="ot">=</span> parameters[<span class="st">&quot;sigma&quot;</span>]</span>
<span id="cb9-54"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-54" tabindex="-1"></a>    </span>
<span id="cb9-55"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-55" tabindex="-1"></a>    <span class="co"># event 1: birth of susceptible</span></span>
<span id="cb9-56"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-56" tabindex="-1"></a>    rates[<span class="dv">1</span>] <span class="ot">&lt;-</span> lambda <span class="sc">*</span> Ntotal  </span>
<span id="cb9-57"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-57" tabindex="-1"></a>    density_change_matrix[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb9-58"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-58" tabindex="-1"></a>    </span>
<span id="cb9-59"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-59" tabindex="-1"></a>    <span class="co"># event 2: infection of susceptible</span></span>
<span id="cb9-60"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-60" tabindex="-1"></a>    rates[<span class="dv">2</span>] <span class="ot">&lt;-</span> beta <span class="sc">*</span> dens[<span class="dv">1</span>] <span class="sc">*</span> dens[<span class="dv">2</span>] <span class="sc">/</span> Ntotal  <span class="co"># beta * X * Y  N, infection</span></span>
<span id="cb9-61"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-61" tabindex="-1"></a>    density_change_matrix[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb9-62"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-62" tabindex="-1"></a>    </span>
<span id="cb9-63"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-63" tabindex="-1"></a>    <span class="co"># event 3: death of susceptible</span></span>
<span id="cb9-64"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-64" tabindex="-1"></a>    rates[<span class="dv">3</span>] <span class="ot">&lt;-</span> mu <span class="sc">*</span> dens[<span class="dv">1</span>] <span class="co"># mu X</span></span>
<span id="cb9-65"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-65" tabindex="-1"></a>    density_change_matrix[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb9-66"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-66" tabindex="-1"></a>    </span>
<span id="cb9-67"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-67" tabindex="-1"></a>    <span class="co"># event 4: loss of infection</span></span>
<span id="cb9-68"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-68" tabindex="-1"></a>    rates[<span class="dv">4</span>] <span class="ot">&lt;-</span> sigma <span class="sc">*</span> dens[<span class="dv">2</span>] <span class="co"># sigma Y</span></span>
<span id="cb9-69"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-69" tabindex="-1"></a>    density_change_matrix[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb9-70"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-70" tabindex="-1"></a>    </span>
<span id="cb9-71"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-71" tabindex="-1"></a>    <span class="co"># event 5: death of infected</span></span>
<span id="cb9-72"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-72" tabindex="-1"></a>    rates[<span class="dv">5</span>] <span class="ot">&lt;-</span> mu <span class="sc">*</span> dens[<span class="dv">2</span>] <span class="co"># mu Y</span></span>
<span id="cb9-73"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-73" tabindex="-1"></a>    density_change_matrix[<span class="dv">5</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb9-74"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-74" tabindex="-1"></a>    </span>
<span id="cb9-75"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-75" tabindex="-1"></a>    <span class="co"># event 6: death of resistant</span></span>
<span id="cb9-76"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-76" tabindex="-1"></a>    rates[<span class="dv">6</span>] <span class="ot">&lt;-</span> mu <span class="sc">*</span> dens[<span class="dv">3</span>] <span class="co"># mu Z, </span></span>
<span id="cb9-77"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-77" tabindex="-1"></a>    density_change_matrix[<span class="dv">6</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb9-78"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-78" tabindex="-1"></a>    </span>
<span id="cb9-79"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-79" tabindex="-1"></a>    <span class="co"># calculate the total rate</span></span>
<span id="cb9-80"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-80" tabindex="-1"></a>    sum_rates <span class="ot">&lt;-</span> <span class="fu">sum</span>(rates)</span>
<span id="cb9-81"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-81" tabindex="-1"></a></span>
<span id="cb9-82"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-82" tabindex="-1"></a>    <span class="co"># random uniformly distributed number</span></span>
<span id="cb9-83"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-83" tabindex="-1"></a>    <span class="co"># between 0 and 1</span></span>
<span id="cb9-84"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-84" tabindex="-1"></a>    rand1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n=</span><span class="dv">1</span>)</span>
<span id="cb9-85"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-85" tabindex="-1"></a>    </span>
<span id="cb9-86"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-86" tabindex="-1"></a>    <span class="co"># calculate time that nothing happens</span></span>
<span id="cb9-87"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-87" tabindex="-1"></a>    ts <span class="ot">&lt;-</span> ts  <span class="sc">-</span><span class="fu">log</span>(rand1) <span class="sc">/</span> (sum_rates)</span>
<span id="cb9-88"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-88" tabindex="-1"></a>    </span>
<span id="cb9-89"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-89" tabindex="-1"></a>    <span class="co"># bounds checking, rates cannot be negative</span></span>
<span id="cb9-90"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-90" tabindex="-1"></a>    <span class="fu">stopifnot</span>(rates <span class="sc">&gt;=</span> <span class="dv">0</span>)    </span>
<span id="cb9-91"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-91" tabindex="-1"></a>    </span>
<span id="cb9-92"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-92" tabindex="-1"></a>    <span class="co"># choose which of 6 events </span></span>
<span id="cb9-93"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-93" tabindex="-1"></a>    <span class="co"># each event has its own &#39;weight&#39; that determines</span></span>
<span id="cb9-94"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-94" tabindex="-1"></a>    <span class="co"># how likely it is to be chosen</span></span>
<span id="cb9-95"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-95" tabindex="-1"></a>    which_event <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,  <span class="co"># a number between 1 and 6</span></span>
<span id="cb9-96"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-96" tabindex="-1"></a>                          <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb9-97"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-97" tabindex="-1"></a>                          <span class="at">prob =</span> rates <span class="co"># weights given by rates</span></span>
<span id="cb9-98"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-98" tabindex="-1"></a>                          )</span>
<span id="cb9-99"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-99" tabindex="-1"></a>    </span>
<span id="cb9-100"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-100" tabindex="-1"></a>    <span class="co"># materialise the actual change in the densities</span></span>
<span id="cb9-101"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-101" tabindex="-1"></a>    dens <span class="ot">=</span> dens <span class="sc">+</span> </span>
<span id="cb9-102"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-102" tabindex="-1"></a>        density_change_matrix[which_event,]</span>
<span id="cb9-103"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-103" tabindex="-1"></a>   </span>
<span id="cb9-104"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-104" tabindex="-1"></a>    <span class="co"># in case newly calculated</span></span>
<span id="cb9-105"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-105" tabindex="-1"></a>    <span class="co"># densities are negative</span></span>
<span id="cb9-106"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-106" tabindex="-1"></a>    <span class="co"># set them to zero</span></span>
<span id="cb9-107"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-107" tabindex="-1"></a>    dens[<span class="fu">which</span>(dens <span class="sc">&lt;</span> <span class="dv">0</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-108"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-108" tabindex="-1"></a>    </span>
<span id="cb9-109"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-109" tabindex="-1"></a>    <span class="co"># return both the densities and the time that nothing happened</span></span>
<span id="cb9-110"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-110" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(ts,dens))</span>
<span id="cb9-111"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-111" tabindex="-1"></a>    </span>
<span id="cb9-112"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-112" tabindex="-1"></a>} <span class="co"># end stoch eqns</span></span>
<span id="cb9-113"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-113" tabindex="-1"></a></span>
<span id="cb9-114"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-114" tabindex="-1"></a></span>
<span id="cb9-115"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-115" tabindex="-1"></a>SIR_Gillespie <span class="ot">&lt;-</span> <span class="cf">function</span>(params, </span>
<span id="cb9-116"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-116" tabindex="-1"></a>                          initial_values, </span>
<span id="cb9-117"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-117" tabindex="-1"></a>                          <span class="at">max_time=</span><span class="dv">100</span>)</span>
<span id="cb9-118"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-118" tabindex="-1"></a>{</span>
<span id="cb9-119"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-119" tabindex="-1"></a>    <span class="cf">if</span> (max_time <span class="sc">&gt;</span> <span class="fl">1e03</span>)</span>
<span id="cb9-120"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-120" tabindex="-1"></a>    {</span>
<span id="cb9-121"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-121" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&quot;Choose max_time to be a smaller value unless you want to wait (very long)&quot;</span>)</span>
<span id="cb9-122"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-122" tabindex="-1"></a>    }</span>
<span id="cb9-123"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-123" tabindex="-1"></a>    </span>
<span id="cb9-124"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-124" tabindex="-1"></a>    <span class="co"># we may have to go through a large number</span></span>
<span id="cb9-125"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-125" tabindex="-1"></a>    <span class="co"># of time steps, but we stop as soon as the</span></span>
<span id="cb9-126"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-126" tabindex="-1"></a>    <span class="co"># actual time &gt; max_time</span></span>
<span id="cb9-127"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-127" tabindex="-1"></a>    max_steps <span class="ot">&lt;-</span> <span class="fl">1e05</span></span>
<span id="cb9-128"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-128" tabindex="-1"></a>    </span>
<span id="cb9-129"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-129" tabindex="-1"></a>    <span class="co"># pre-allocate data for the numerical output</span></span>
<span id="cb9-130"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-130" tabindex="-1"></a>    <span class="co"># very difficult to predict size needed as</span></span>
<span id="cb9-131"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-131" tabindex="-1"></a>    <span class="co"># by chance, some simulations may involve</span></span>
<span id="cb9-132"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-132" tabindex="-1"></a>    <span class="co"># more events than others </span></span>
<span id="cb9-133"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-133" tabindex="-1"></a>    variables <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="at">data =</span><span class="dv">0</span>, <span class="co"># fill with zeros</span></span>
<span id="cb9-134"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-134" tabindex="-1"></a>                        <span class="at">nrow=</span>max_steps,  <span class="co"># max_steps rows</span></span>
<span id="cb9-135"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-135" tabindex="-1"></a>                        <span class="at">ncol=</span><span class="dv">5</span>))</span>
<span id="cb9-136"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-136" tabindex="-1"></a>    </span>
<span id="cb9-137"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-137" tabindex="-1"></a>    <span class="co"># give names to the columns</span></span>
<span id="cb9-138"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-138" tabindex="-1"></a>    <span class="co"># notice that we have time as the total</span></span>
<span id="cb9-139"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-139" tabindex="-1"></a>    <span class="co"># number of events that happened (T)</span></span>
<span id="cb9-140"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-140" tabindex="-1"></a>    <span class="co"># and actual time (total number of events</span></span>
<span id="cb9-141"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-141" tabindex="-1"></a>    <span class="co"># * time steps in between events) captured</span></span>
<span id="cb9-142"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-142" tabindex="-1"></a>    <span class="co"># in the variable time</span></span>
<span id="cb9-143"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-143" tabindex="-1"></a>    <span class="fu">colnames</span>(variables) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;T&quot;</span>,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;S&quot;</span>,<span class="st">&quot;I&quot;</span>,<span class="st">&quot;R&quot;</span>)</span>
<span id="cb9-144"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-144" tabindex="-1"></a>    </span>
<span id="cb9-145"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-145" tabindex="-1"></a>    <span class="co"># set initial time and initial values</span></span>
<span id="cb9-146"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-146" tabindex="-1"></a>    variables[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, initial_values)</span>
<span id="cb9-147"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-147" tabindex="-1"></a>   </span>
<span id="cb9-148"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-148" tabindex="-1"></a>    <span class="co"># keep track of the real time that accumulates </span></span>
<span id="cb9-149"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-149" tabindex="-1"></a>    <span class="co"># between events</span></span>
<span id="cb9-150"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-150" tabindex="-1"></a>    real_time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-151"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-151" tabindex="-1"></a>    </span>
<span id="cb9-152"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-152" tabindex="-1"></a>    <span class="co"># keep track of counter of the number of events</span></span>
<span id="cb9-153"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-153" tabindex="-1"></a>    step_idx <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb9-154"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-154" tabindex="-1"></a>    </span>
<span id="cb9-155"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-155" tabindex="-1"></a>    <span class="co"># now iterate the system for max_time steps</span></span>
<span id="cb9-156"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-156" tabindex="-1"></a>    <span class="cf">while</span> (real_time <span class="sc">&lt;</span> max_time)</span>
<span id="cb9-157"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-157" tabindex="-1"></a>    {</span>
<span id="cb9-158"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-158" tabindex="-1"></a>        <span class="co"># evaluate the stochastic equations</span></span>
<span id="cb9-159"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-159" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">stoch_eqns</span>(</span>
<span id="cb9-160"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-160" tabindex="-1"></a>            <span class="at">input=</span>variables[step_idx <span class="sc">-</span> <span class="dv">1</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb9-161"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-161" tabindex="-1"></a>            <span class="at">params =</span> params)</span>
<span id="cb9-162"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-162" tabindex="-1"></a>        </span>
<span id="cb9-163"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-163" tabindex="-1"></a>        <span class="co"># update the current time</span></span>
<span id="cb9-164"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-164" tabindex="-1"></a>        real_time <span class="ot">&lt;-</span> result[<span class="dv">1</span>]</span>
<span id="cb9-165"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-165" tabindex="-1"></a>        </span>
<span id="cb9-166"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-166" tabindex="-1"></a>        <span class="co"># update all the variables</span></span>
<span id="cb9-167"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-167" tabindex="-1"></a>        <span class="co"># from the stochastic equations</span></span>
<span id="cb9-168"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-168" tabindex="-1"></a>        variables[step_idx,] <span class="ot">&lt;-</span> <span class="fu">c</span>(step_idx, result)</span>
<span id="cb9-169"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-169" tabindex="-1"></a></span>
<span id="cb9-170"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-170" tabindex="-1"></a>        <span class="co"># if all the densities are 0 </span></span>
<span id="cb9-171"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-171" tabindex="-1"></a>        <span class="co"># then population extinct, quit</span></span>
<span id="cb9-172"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-172" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(result[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(result)]) <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">||</span></span>
<span id="cb9-173"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-173" tabindex="-1"></a>            real_time <span class="sc">&gt;</span> max_time)</span>
<span id="cb9-174"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-174" tabindex="-1"></a>        {</span>
<span id="cb9-175"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-175" tabindex="-1"></a>            <span class="co"># drop the remainder of the variables</span></span>
<span id="cb9-176"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-176" tabindex="-1"></a>            <span class="co"># table as it will be unfilled anyway</span></span>
<span id="cb9-177"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-177" tabindex="-1"></a>            variables <span class="ot">&lt;-</span> variables[<span class="dv">1</span><span class="sc">:</span>step_idx,]</span>
<span id="cb9-178"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-178" tabindex="-1"></a>            </span>
<span id="cb9-179"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-179" tabindex="-1"></a>            <span class="co"># the final event</span></span>
<span id="cb9-180"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-180" tabindex="-1"></a>            <span class="co"># has happened after max_time</span></span>
<span id="cb9-181"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-181" tabindex="-1"></a>            <span class="co"># at max_time itself the state of</span></span>
<span id="cb9-182"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-182" tabindex="-1"></a>            <span class="co"># the population is the same</span></span>
<span id="cb9-183"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-183" tabindex="-1"></a>            <span class="co"># as previous</span></span>
<span id="cb9-184"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-184" tabindex="-1"></a>            variables[step_idx,] <span class="ot">&lt;-</span> variables[step_idx <span class="sc">-</span><span class="dv">1</span>,]</span>
<span id="cb9-185"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-185" tabindex="-1"></a>            variables[step_idx,<span class="st">&quot;time&quot;</span>] <span class="ot">&lt;-</span> max_time</span>
<span id="cb9-186"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-186" tabindex="-1"></a>            </span>
<span id="cb9-187"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-187" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb9-188"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-188" tabindex="-1"></a>        }</span>
<span id="cb9-189"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-189" tabindex="-1"></a>        </span>
<span id="cb9-190"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-190" tabindex="-1"></a>        <span class="co"># increase data.frame size if needed</span></span>
<span id="cb9-191"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-191" tabindex="-1"></a>        <span class="cf">if</span> (step_idx <span class="sc">==</span> <span class="fu">nrow</span>(variables))</span>
<span id="cb9-192"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-192" tabindex="-1"></a>        {</span>
<span id="cb9-193"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-193" tabindex="-1"></a>            variables <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb9-194"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-194" tabindex="-1"></a>                variables,</span>
<span id="cb9-195"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-195" tabindex="-1"></a>                <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="at">data =</span><span class="dv">0</span>, <span class="co"># fill with zeros</span></span>
<span id="cb9-196"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-196" tabindex="-1"></a>                            <span class="at">nrow=</span>max_steps,  <span class="co"># max_steps rows</span></span>
<span id="cb9-197"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-197" tabindex="-1"></a>                            <span class="at">ncol=</span><span class="dv">5</span>))</span>
<span id="cb9-198"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-198" tabindex="-1"></a>            )</span>
<span id="cb9-199"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-199" tabindex="-1"></a>        }</span>
<span id="cb9-200"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-200" tabindex="-1"></a>        step_idx <span class="ot">&lt;-</span> step_idx  <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-201"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-201" tabindex="-1"></a>    } <span class="co"># end for</span></span>
<span id="cb9-202"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-202" tabindex="-1"></a>    </span>
<span id="cb9-203"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-203" tabindex="-1"></a>    <span class="co"># drop lines that are empty as we exceeded</span></span>
<span id="cb9-204"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-204" tabindex="-1"></a>    <span class="co"># the time we needed to run this for</span></span>
<span id="cb9-205"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-205" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">as.data.frame</span>(variables))</span>
<span id="cb9-206"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-206" tabindex="-1"></a>} <span class="co"># end SIR_Gillespie</span></span>
<span id="cb9-207"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-207" tabindex="-1"></a></span>
<span id="cb9-208"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-208" tabindex="-1"></a><span class="co"># specify the parameters</span></span>
<span id="cb9-209"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-209" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="dv">2</span>, <span class="at">sigma =</span> <span class="fl">0.25</span>, <span class="at">mu =</span> <span class="fl">1e-05</span>, <span class="at">lambda =</span> <span class="fl">1e-05</span>)</span>
<span id="cb9-210"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-210" tabindex="-1"></a>initial_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">5000</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb9-211"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-211" tabindex="-1"></a></span>
<span id="cb9-212"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-212" tabindex="-1"></a><span class="co"># run the Gillespie model</span></span>
<span id="cb9-213"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-213" tabindex="-1"></a>first_result <span class="ot">&lt;-</span> <span class="fu">SIR_Gillespie</span>(</span>
<span id="cb9-214"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-214" tabindex="-1"></a>    <span class="at">params =</span> parameters,</span>
<span id="cb9-215"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-215" tabindex="-1"></a>    <span class="at">initial_values =</span> initial_values,</span>
<span id="cb9-216"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-216" tabindex="-1"></a>    <span class="at">max_time =</span> <span class="dv">80</span>)</span>
<span id="cb9-217"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-217" tabindex="-1"></a></span>
<span id="cb9-218"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-218" tabindex="-1"></a><span class="co"># our data is current in wide format</span></span>
<span id="cb9-219"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-219" tabindex="-1"></a><span class="co"># with each row consisting of time, T, S, I and R</span></span>
<span id="cb9-220"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-220" tabindex="-1"></a><span class="co"># but to plot things easily using ggplot2</span></span>
<span id="cb9-221"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-221" tabindex="-1"></a><span class="co"># we want things in long format</span></span>
<span id="cb9-222"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-222" tabindex="-1"></a>first_result_l <span class="ot">&lt;-</span> first_result <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(S,I,R)</span>
<span id="cb9-223"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-223" tabindex="-1"></a>                               ,<span class="at">names_to =</span> <span class="st">&quot;Type&quot;</span></span>
<span id="cb9-224"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-224" tabindex="-1"></a>                               ,<span class="at">values_to =</span> <span class="st">&quot;Density&quot;</span>)</span>
<span id="cb9-225"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-225" tabindex="-1"></a></span>
<span id="cb9-226"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-226" tabindex="-1"></a><span class="co"># plot the result</span></span>
<span id="cb9-227"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-227" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>first_result_l,</span>
<span id="cb9-228"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-228" tabindex="-1"></a>       <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Density)) <span class="sc">+</span></span>
<span id="cb9-229"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-229" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">colour =</span> Type)) <span class="sc">+</span></span>
<span id="cb9-230"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-230" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb9-231"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-231" tabindex="-1"></a>    <span class="fu">scale_colour_brewer</span>(<span class="at">palette=</span><span class="st">&quot;Set1&quot;</span>) <span class="sc">+</span></span>
<span id="cb9-232"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-232" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb9-233"><a href="practical-probabilistic-models-in-disease-evolution.html#cb9-233" tabindex="-1"></a>    <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">80</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="task-running-the-model" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Task: running the model<a href="practical-probabilistic-models-in-disease-evolution.html#task-running-the-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Run the model for a large population size. Start with <span class="math inline">\(S=5000\)</span>, which dependent on the speed of your computer may take a little while.</p>
<p>Without changing the parameters, you may see
sometimes see a plot that looks like this:
<img src="_main_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>You notice that there are no infected individuals! Why do you think this is so?
Think about the role of chance effects covered in the lecture.</p>
</div>
<div id="task-running-the-above-for-small-population-sizes" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Task: running the above for small population sizes<a href="practical-probabilistic-models-in-disease-evolution.html#task-running-the-above-for-small-population-sizes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now try the same but then for very small populations, i.e., <span class="math inline">\(S = 50\)</span>. What do you notice about the shapes of the lines? Are they still as smooth as for <span class="math inline">\(S=5000\)</span>. If you run this repeatedly, do you find that the population always gets infected?</p>
</div>
<div id="task-running-and-plotting-replicate-sims" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Task: running and plotting replicate sims<a href="practical-probabilistic-models-in-disease-evolution.html#task-running-and-plotting-replicate-sims" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far we just ran the same simulation a bunch of times by selecting the same code over and over again, which is slightly tedious. We can also build a <code>for</code>
loop that allows us to obtain multiple results more quickly.
We then combine these results in a big data frame. Note that each simulation run is uniquely numbered, so that we can keep track of which replicate is which when plotting the simulations. Take a look at the code below for 10 replicates:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-1" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="dv">1</span>,<span class="at">sigma=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>,<span class="at">mu=</span><span class="fl">1e-05</span>,<span class="at">lambda=</span><span class="fl">1e-05</span>)</span>
<span id="cb10-2"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-3" tabindex="-1"></a>init_dens <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">200</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb10-4"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-5" tabindex="-1"></a>tmax <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb10-6"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-7" tabindex="-1"></a><span class="co"># allocate an empty dataframe</span></span>
<span id="cb10-8"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-8" tabindex="-1"></a><span class="co"># this will contain all the replicate simulations</span></span>
<span id="cb10-9"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-9" tabindex="-1"></a>all_the_simulations <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-10"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-11" tabindex="-1"></a><span class="co"># number of replicates</span></span>
<span id="cb10-12"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-12" tabindex="-1"></a>number_replicates <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb10-13"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-13" tabindex="-1"></a></span>
<span id="cb10-14"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-14" tabindex="-1"></a><span class="co"># use a for loop to gather replicate simulations</span></span>
<span id="cb10-15"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-15" tabindex="-1"></a><span class="cf">for</span> (replicate_sim_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>number_replicates)</span>
<span id="cb10-16"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-16" tabindex="-1"></a>{</span>
<span id="cb10-17"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-17" tabindex="-1"></a>    <span class="co"># run a single replicate simulation</span></span>
<span id="cb10-18"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-18" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">SIR_Gillespie</span>(<span class="at">params =</span> parameters, <span class="at">initial_values =</span> init_dens,<span class="at">max_time =</span> tmax)   </span>
<span id="cb10-19"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-20" tabindex="-1"></a>    <span class="co"># give this replicate simulation a column</span></span>
<span id="cb10-21"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-21" tabindex="-1"></a>    <span class="co"># called replicate_id, so that all rows</span></span>
<span id="cb10-22"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-22" tabindex="-1"></a>    <span class="co"># of this particular data set will have</span></span>
<span id="cb10-23"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-23" tabindex="-1"></a>    <span class="co"># the same replicate_id</span></span>
<span id="cb10-24"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-24" tabindex="-1"></a>    result <span class="ot">&lt;-</span> result <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb10-25"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-25" tabindex="-1"></a>        <span class="at">replicate_id =</span> <span class="fu">as.character</span>(replicate_sim_idx) <span class="co"># store as text so that it becomes a factor</span></span>
<span id="cb10-26"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-26" tabindex="-1"></a>    )</span>
<span id="cb10-27"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-27" tabindex="-1"></a>    </span>
<span id="cb10-28"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-28" tabindex="-1"></a>    <span class="co"># append the result to the big dataset</span></span>
<span id="cb10-29"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-29" tabindex="-1"></a>    all_the_simulations <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb10-30"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-30" tabindex="-1"></a>        all_the_simulations,result</span>
<span id="cb10-31"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-31" tabindex="-1"></a>    )</span>
<span id="cb10-32"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-32" tabindex="-1"></a>} <span class="co"># end for loop</span></span>
<span id="cb10-33"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-34" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> all_the_simulations</span>
<span id="cb10-35"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-35" tabindex="-1"></a>       ,<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> I)) <span class="sc">+</span></span>
<span id="cb10-36"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-36" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb10-37"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-37" tabindex="-1"></a>        <span class="at">colour =</span> replicate_id)) <span class="sc">+</span></span>
<span id="cb10-38"><a href="practical-probabilistic-models-in-disease-evolution.html#cb10-38" tabindex="-1"></a>    <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>One can also try to join up all the replicates of S, I and R in one plot, so that it looks like this:</p>
<p><img src="_main_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
</div>
<div id="task-what-happens-when-r_0-1" class="section level3 hasAnchor" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> Task: what happens when <span class="math inline">\(R_{0} &lt; 1\)</span>?<a href="practical-probabilistic-models-in-disease-evolution.html#task-what-happens-when-r_0-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Using the code above, run the simulation for an initial susceptible density of <span class="math inline">\(S = 100\)</span> and change the value of <span class="math inline">\(\sigma\)</span> and/or <span class="math inline">\(\beta\)</span> so that we have an R0 of 0.95 (i.e., the disease is not expected to invade according to all our deterministic models so far).</p>
<p>Try to run 50 replicates.</p>
<p>Do we indeed find that the disease is never able to invade? Discuss why your findings look like this. <em>hint: consider the role of chance effects</em></p>
</div>
<div id="advanced-task-systematically-vary-population-size-and-look-at-extinction" class="section level3 hasAnchor" number="3.2.6">
<h3><span class="header-section-number">3.2.6</span> Advanced task: systematically vary population size and look at extinction<a href="practical-probabilistic-models-in-disease-evolution.html#advanced-task-systematically-vary-population-size-and-look-at-extinction" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Warning: running this code can take quite a while</strong>
We could also vary the population density (by means of varying the initial density of susceptibles <span class="math inline">\(S\)</span>). We then can study the time it takes for a disease to go extinct in different populations. The code below does exactly this.</p>
<p>Before going ahead and running it, what would you expect? Are diseases more likely to maintain themselves in large versus small populations?</p>
<p>After running the code below, what do you conclude? Would a 10% increase in population density matter dramatically to disease extinction when the current population is already quite large? What about a 10% increase in size of a small population?</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-1" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="dv">1</span>,<span class="at">sigma=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">15</span>,<span class="at">mu=</span><span class="fl">1e-05</span>,<span class="at">lambda=</span><span class="fl">1e-05</span>)</span>
<span id="cb11-2"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-4" tabindex="-1"></a>tmax <span class="ot">=</span> <span class="dv">150</span></span>
<span id="cb11-5"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-6" tabindex="-1"></a><span class="co"># vary S as this sets the population size</span></span>
<span id="cb11-7"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-7" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">50</span>,<span class="dv">75</span>,<span class="dv">500</span>,<span class="dv">2000</span>,<span class="dv">4000</span>)</span>
<span id="cb11-8"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-9" tabindex="-1"></a><span class="co"># number of replicates</span></span>
<span id="cb11-10"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-10" tabindex="-1"></a>number_replicates <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb11-11"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-11" tabindex="-1"></a></span>
<span id="cb11-12"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-12" tabindex="-1"></a><span class="co"># allocate data on extinction</span></span>
<span id="cb11-13"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-13" tabindex="-1"></a>data_extinction <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-14"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-14" tabindex="-1"></a>    <span class="at">run_id =</span> <span class="dv">1</span><span class="sc">:</span>number_replicates <span class="sc">*</span> <span class="fu">length</span>(S)</span>
<span id="cb11-15"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-15" tabindex="-1"></a>)</span>
<span id="cb11-16"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-17" tabindex="-1"></a><span class="co"># allocate two additional column to put the extinction times in, the value of S</span></span>
<span id="cb11-18"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-18" tabindex="-1"></a>data_extinction[,<span class="fu">c</span>(<span class="st">&quot;time_extinct&quot;</span>,<span class="st">&quot;S&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb11-19"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-19" tabindex="-1"></a></span>
<span id="cb11-20"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-20" tabindex="-1"></a>run_id <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-21"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-21" tabindex="-1"></a><span class="co"># use a for loop to gather replicate simulations</span></span>
<span id="cb11-22"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-22" tabindex="-1"></a><span class="cf">for</span> (s_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(S))</span>
<span id="cb11-23"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-23" tabindex="-1"></a>{</span>
<span id="cb11-24"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-24" tabindex="-1"></a>    init_dens <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> S[s_idx], </span>
<span id="cb11-25"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-25" tabindex="-1"></a>                   <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb11-26"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-26" tabindex="-1"></a>    </span>
<span id="cb11-27"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-27" tabindex="-1"></a>    <span class="cf">for</span> (replicate_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>number_replicates)</span>
<span id="cb11-28"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-28" tabindex="-1"></a>    {</span>
<span id="cb11-29"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-29" tabindex="-1"></a>        <span class="co"># run a single replicate simulation</span></span>
<span id="cb11-30"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-30" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">SIR_Gillespie</span>(<span class="at">params =</span> parameters, <span class="at">initial_values =</span> init_dens,<span class="at">max_time =</span> tmax)   </span>
<span id="cb11-31"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-31" tabindex="-1"></a>        </span>
<span id="cb11-32"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-32" tabindex="-1"></a>        <span class="co"># we want to find the time that I went extinct</span></span>
<span id="cb11-33"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-33" tabindex="-1"></a>        all_times_extinct <span class="ot">&lt;-</span> result <span class="sc">%&gt;%</span> <span class="fu">filter</span>(I <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(time)</span>
<span id="cb11-34"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-34" tabindex="-1"></a>        </span>
<span id="cb11-35"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-35" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(all_times_extinct) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb11-36"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-36" tabindex="-1"></a>        {</span>
<span id="cb11-37"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-37" tabindex="-1"></a>            time_extinction <span class="ot">=</span> tmax </span>
<span id="cb11-38"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-38" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb11-39"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-39" tabindex="-1"></a>        <span class="co"># find the earliest time that this happend</span></span>
<span id="cb11-40"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-40" tabindex="-1"></a>            time_extinction <span class="ot">&lt;-</span> <span class="fu">min</span>(all_times_extinct)</span>
<span id="cb11-41"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-41" tabindex="-1"></a>        }</span>
<span id="cb11-42"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-42" tabindex="-1"></a>        </span>
<span id="cb11-43"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-43" tabindex="-1"></a>        data_extinction[run_id</span>
<span id="cb11-44"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-44" tabindex="-1"></a>                        ,<span class="fu">c</span>(<span class="st">&quot;S&quot;</span>,<span class="st">&quot;time_extinct&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(S[s_idx],time_extinction)</span>
<span id="cb11-45"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-45" tabindex="-1"></a>        </span>
<span id="cb11-46"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-46" tabindex="-1"></a>        run_id <span class="ot">&lt;-</span> run_id <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-47"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-47" tabindex="-1"></a>    } <span class="co"># end for replicate idx</span></span>
<span id="cb11-48"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-48" tabindex="-1"></a>} <span class="co">#end for s_idx</span></span>
<span id="cb11-49"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-49" tabindex="-1"></a></span>
<span id="cb11-50"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-50" tabindex="-1"></a></span>
<span id="cb11-51"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-51" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data_extinction,</span>
<span id="cb11-52"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-52" tabindex="-1"></a>       ,<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">y =</span> time_extinct)) <span class="sc">+</span></span>
<span id="cb11-53"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-53" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb11-54"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-54" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb11-55"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-55" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Population size (init S)&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-56"><a href="practical-probabilistic-models-in-disease-evolution.html#cb11-56" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Time until disease extinct&quot;</span>)</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="practical-uncertainties.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="practical-fitting-dynamic-models-to-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/02-stochasticity.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
